[
  {
    "UpdateStageName": "Create MongoDB directories",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}mongodb"
  },
  {
    "UpdateStageName": "Create MongoDB Shell directories",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}mongosh"
  },
  {
    "UpdateStageName": "Create data directory",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}{{DataDirectory}}"
  },
  {
    "UpdateStageName": "Create log directory",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}{{LogDirectory}}"
  },
  {
    "UpdateStageName": "Download MongoDB Server",
    "UpdateSourcePlatform": "Linux",
    "UpdateSource": "Executable",
    "UpdateSourceData": "/bin/bash",
    "UpdateSourceArgs": "-c \"cd '{{$FullBaseDir}}' && echo 'Debug: Starting MongoDB download' && MongoDBRelease='{{ServerVersion}}' && MongoDBVersion='{{CustomServerVersion}}' && echo 'Debug: Release=$MongoDBRelease, Version=$MongoDBVersion' && if [ -x 'mongodb/bin/mongod' ]; then InstalledVersion=$(mongodb/bin/mongod --version | grep 'db version' | grep -oE '[0-9]+\\.[0-9]+\\.[0-9]+'); echo 'Debug: InstalledVersion=$InstalledVersion'; else InstalledVersion=''; fi && if [ -z \"$MongoDBVersion\" ]; then echo 'Debug: Fetching latest version from API' && MongoDBVersion=$(wget -qO- \"https://endoflife.date/api/v1/products/mongodb/releases/$MongoDBRelease\" | jq -r '.result.latest.name'); echo 'Debug: Fetched version=$MongoDBVersion'; fi && echo 'Debug: Checking version pattern: $MongoDBVersion' && if [[ ! \"$MongoDBVersion\" =~ ^[0-9]+\\.[0-9]+\\.[0-9]+$ ]]; then echo \"Invalid MongoDB version: $MongoDBVersion\"; exit 1; fi && if [ \"$InstalledVersion\" = \"$MongoDBVersion\" ]; then echo \"MongoDB v$MongoDBVersion already installed\"; exit 0; fi && echo 'Debug: Downloading MongoDB $MongoDBVersion' && wget -qO mongodb.tgz \"https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-debian12-$MongoDBVersion.tgz\" && tar -xzf mongodb.tgz -C mongodb --strip-components=1 && rm -f mongodb.tgz && echo \"MongoDB v$MongoDBVersion downloaded\"",
    "SkipOnFailure": false
  },
  {
    "UpdateStageName": "Download MongoDB Shell",
    "UpdateSourcePlatform": "Linux",
    "UpdateSource": "Executable",
    "UpdateSourceData": "/bin/bash",
    "UpdateSourceArgs": "-c \"cd '{{$FullBaseDir}}' && if [ -x 'mongosh/bin/mongosh' ]; then InstalledVersion=$(mongosh/bin/mongosh --version | head -1); else InstalledVersion=''; fi && LatestVersion=$(wget -qO- 'https://api.github.com/repos/mongodb-js/mongosh/releases/latest' | jq -r '.tag_name' | sed 's/^v//') && if [ \"$InstalledVersion\" = \"$LatestVersion\" ]; then echo 'MongoDB Shell v$LatestVersion already installed'; exit 0; fi && wget -qO mongosh.tgz https://downloads.mongodb.com/compass/mongosh-$LatestVersion-linux-x64.tgz && tar -xzf mongosh.tgz -C mongosh --strip-components=1 && rm -f mongosh.tgz && echo 'MongoDB Shell v$LatestVersion downloaded'",
    "SkipOnFailure": false
  },
  {
    "UpdateStageName": "Initialize MongoDB",
    "UpdateSourcePlatform": "Linux",
    "UpdateSource": "Executable",
    "UpdateSourceData": "/bin/bash",
    "UpdateSourceArgs": "-c \"cd '{{$FullBaseDir}}' && if [ ! -f '{{$FullBaseDir}}{{DataDirectory}}/WiredTiger' ]; then mongodb/bin/mongod --dbpath '{{$FullBaseDir}}{{DataDirectory}}' --fork --logpath '{{$FullBaseDir}}{{LogDirectory}}/mongod.log' --logappend --fork && sleep 2 && mongodb/bin/mongosh --eval 'db.shutdownServer()' admin && echo 'MongoDB initialized'; fi\""
  }
]