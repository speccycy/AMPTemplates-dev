[
  {
    "UpdateStageName": "Create MongoDB directories",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}mongodb"
  },
  {
    "UpdateStageName": "Create MongoDB Shell directories",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}mongosh"
  },
  {
    "UpdateStageName": "Create data directory",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}{{DataDirectory}}"
  },
  {
    "UpdateStageName": "Create log directory",
    "UpdateSourcePlatform": "All",
    "UpdateSource": "CreateDirectory",
    "UpdateSourceArgs": "{{$FullBaseDir}}{{LogDirectory}}"
  },
  {
    "UpdateStageName": "Download MongoDB Server",
    "UpdateSourcePlatform": "Linux",
    "UpdateSource": "Executable",
    "UpdateSourceData": "/bin/bash",
    "UpdateSourceArgs": "-c \"MongoDBRelease=\\\"{{ServerVersion}}\\\"; MongoDBVersion=\\\"{{CustomServerVersion}}\\\"; cd '{{$FullBaseDir}}' && if [[ -x mongodb/bin/mongod ]]; then InstalledVersion=$(mongodb/bin/mongod --version | grep 'db version' | grep -oE '[0-9]+\\\\.[0-9]+\\\\.[0-9]+'); else InstalledVersion=\\\"\\\"; fi; [[ -z \\\"$MongoDBVersion\\\" ]] && MongoDBVersion=$(wget -qO- \\\"https://endoflife.date/api/v1/products/mongodb/releases/$MongoDBRelease\\\" | jq -r \\\".result.latest.name\\\"); if [[ ! \\\"$MongoDBVersion\\\" =~ ^[0-9]+\\\\.[0-9]+\\\\.[0-9]+$ ]]; then echo \\\"Invalid MongoDB version format specified\\\" && exit 1; elif [[ \\\"$InstalledVersion\\\" == \\\"$MongoDBVersion\\\" ]]; then echo \\\"MongoDB v$MongoDBVersion already installed. Skipping\\\" && exit 0; else [[ -f mongodb.tgz ]] && rm -f mongodb.tgz >/dev/null 2>&1; wget -qO mongodb.tgz \\\"https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-debian12-$MongoDBVersion.tgz\\\" || { echo \\\"Download failed from the MongoDB CDN. This is a fault with the CDN, not AMP. Aborting\\\"; exit 1; }; mkdir -p mongodb && rm -rf mongodb/* >/dev/null 2>&1 && tar -xzf mongodb.tgz -C mongodb --strip-components=1 >/dev/null 2>&1 && rm -f mongodb.tgz >/dev/null 2>&1 && echo \\\"MongoDB v$MongoDBVersion downloaded\\\"; fi\"",
    "SkipOnFailure": false
  },
  {
    "UpdateStageName": "Download MongoDB Shell",
    "UpdateSourcePlatform": "Linux",
    "UpdateSource": "Executable",
    "UpdateSourceData": "/bin/bash",
    "UpdateSourceArgs": "-c \"cd '{{$FullBaseDir}}' && if [[ -x mongosh/bin/mongosh ]]; then InstalledVersion=$(mongosh/bin/mongosh --version); else InstalledVersion=\\\"\\\"; fi; LatestVersion=$(wget -qO- \\\"https://api.github.com/repos/mongodb-js/mongosh/releases/latest\\\" | jq -r \\\".tag_name\\\" | sed 's/^v//') && if [[ \\\"$InstalledVersion\\\" == \\\"$LatestVersion\\\" ]]; then echo \\\"MongoDB Shell v$LatestVersion already installed. Skipping\\\" && exit 0; else [[ -f mongosh.tgz ]] && rm -f mongosh.tgz >/dev/null 2>&1; wget -qO mongosh.tgz \\\"https://downloads.mongodb.com/compass/mongosh-$LatestVersion-linux-x64.tgz\\\" || { echo \\\"Download failed from the MongoDB CDN. This is a fault with the CDN, not AMP. Aborting\\\"; exit 1; }; mkdir -p mongosh && rm -rf mongosh/* >/dev/null 2>&1 && tar -xzf mongosh.tgz -C mongosh --strip-components=1 >/dev/null 2>&1 && rm -f mongosh.tgz >/dev/null 2>&1 && echo \\\"MongoDB Shell v$LatestVersion downloaded\\\"; fi\"",
    "SkipOnFailure": false
  },
  {
    "UpdateStageName": "Initialize MongoDB",
    "UpdateSourcePlatform": "Linux",
    "UpdateSource": "Executable",
    "UpdateSourceData": "/bin/bash",
    "UpdateSourceArgs": "-c \"cd '{{$FullBaseDir}}' && if [[ ! -f '{{$FullBaseDir}}{{DataDirectory}}/WiredTiger' ]]; then mongodb/bin/mongod --dbpath '{{$FullBaseDir}}{{DataDirectory}}' --fork --logpath '{{$FullBaseDir}}{{LogDirectory}}/mongod.log' --logappend --fork && sleep 2 && mongodb/bin/mongosh --eval 'db.shutdownServer()' admin && echo \\\"MongoDB initialized\\\"; fi\""
  }
]